# UUID Migration Summary

## Overview
Modified the backend architecture to support UUID primary keys generated by the database instead of application-generated identifiers.

## Changes Made

### 1. Database Operations
All INSERT statements now:
- No longer provide the primary key value (UUID)
- Use `RETURNING` clause to retrieve the database-generated UUID
- Use `fetchval()` or `fetchrow()` to capture the returned UUID

### 2. Modified Files

#### `/src/api/routes/cases.py`
- `create_case()`: Removed `case_id` from INSERT, returns database-generated UUID
- Requested documents also get database-generated UUIDs

#### `/src/api/routes/documents.py`
- `store_document_analysis()`: Removed `analysis_id` generation, returns database UUID
- Removed unused `uuid` import

#### `/src/api/routes/workflows.py`
- `create_workflow()`: Removed `workflow_id` from INSERT, returns database UUID

#### `/src/services/email_service.py`
- `send_email_via_resend()`: Returns database-generated UUID for communications
- Removed unused `uuid` import

#### `/src/models/case.py`
- `CaseCreateRequest`: Removed `case_id` field (now generated by DB)

#### `/src/models/workflow.py`
- `WorkflowCreateRequest`: Removed `workflow_id` field (now generated by DB)

## API Changes

### Case Creation
**Before:**
```json
{
  "case_id": "case_238429843",
  "client_name": "John Doe",
  "client_email": "john@example.com",
  "requested_documents": [...]
}
```

**After:**
```json
{
  "client_name": "John Doe",
  "client_email": "john@example.com",
  "requested_documents": [...]
}
```

Response includes the database-generated UUID in `case_id` field.

### Workflow Creation
**Before:**
```json
{
  "workflow_id": "wf_abc123",
  "agent_type": "CommunicationsAgent",
  "status": "PENDING",
  "initial_prompt": "..."
}
```

**After:**
```json
{
  "agent_type": "CommunicationsAgent",
  "status": "PENDING",
  "initial_prompt": "..."
}
```

Response includes the database-generated UUID in `workflow_id` field.

## Database Schema Requirements
All affected tables must have:
1. UUID column as primary key with default value `gen_random_uuid()`
2. Example DDL:
```sql
CREATE TABLE cases (
    case_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    -- other columns...
);
```

## Testing Recommendations
1. Test case creation without providing case_id
2. Test workflow creation without providing workflow_id
3. Verify returned UUIDs are valid and stored correctly
4. Test document analysis creation returns proper UUID
5. Test email sending returns communication UUID